<form class="mg-crew-sheet sheet actor flexcol" autocomplete="off">

	<nav class="sheet-tabs floating tabs">
		<a class="item" data-tab="party"><i class="fa-solid fa-users"></i> <span>Party</span></a>
		<a class="item" data-tab="initiative"><i class="fa-solid fa-list-ol"></i> <span>Initiative</span></a>
		<a class="item" data-tab="assets"><i class="fa-solid fa-vault"></i> <span>Assets</span></a>
		<a class="item" data-tab="gambits"><i class="fa-solid fa-cards-blank"></i><span>Gambits</span></a>
		<a class="item" data-tab="bio"><i class="fa-solid fa-id-card-clip"></i><span>Bio</span></a>
		<a class="item" data-tab="settings"><i class="fa-solid fa-gear"></i> <span>Settings</span></a>
	</nav>

	<!-- Splash banner: party portraits -->
	<div class="mg-crew-header">
		<!-- Crew Title / Name -->
		<div class="mg-crew-title">
			<div class="title-tier">
				{{#if canEdit}}
				<input type="text"
						name="name"
						value="{{actor.name}}"
						class="mg-crew-name"
						placeholder="Crew Name" />
				<span class="crew-tier-badge">Tier {{crewTier}}</span>

				{{else}}
				<h1 class="mg-crew-name-display">{{actor.name}}</h1>
				<span class="crew-tier-badge">Tier {{crewTier}}</span>
				{{/if}}
			</div>

		</div>

		<div class="mg-splash-strip">
			{{#each splashImages as |img|}}
				<img class="mg-splash-portrait" src="{{img}}" alt="" />
			{{/each}}
		</div>
	</div>

	<section class="sheet-body">
		<!-- PARTY TAB -->
		<div class="tab party-tab" data-tab="party">
			<div class="tab-wrapper">
				<div class="mg-content">
					{{#if canEdit}}
					<h2>Party List</h2>
					<p>Drag characters from the Actors directory onto this sheet to add them to the party</p>
					{{else}}
					<h2>View Only</h2>
					<p>You can view the party. Owners can edit</p>
					{{/if}}
				</div>

				<div class="mg-party-grid">
					{{#each partyMembers as |m|}}
					<article class="mg-member-card" data-uuid="{{m.uuid}}">
						<div class="mg-member-portrait">
							<img src="{{m.img}}" alt="{{m.name}}" />
						</div>
						<div class="mg-member-info">
							<div class="mg-member-name">{{m.name}}</div>
							<div class="mg-member-meta">
								<span class="mg-member-class">{{m.className}}</span>
								<span class="mg-member-level">Lv {{m.levelText}}</span>
								{{#if m.missing}}<span class="mg-member-missing">(Missing)</span>{{/if}}
							</div>
						</div>

						<div class="mg-member-actions">

							<button type="button" class="mg-open-member" title="Open Character Sheet" aria-label="Open Character Sheet">
								<i class="fa-solid fa-address-card"></i>
							</button>

							<div class="mg-member" data-actor-id="{{actorId}}">
								<!-- avatar, name, etc. -->
								{{#if ../canEdit}}
									<button type="button" class="mg-remove-member" title="Remove from Party">
									<i class="fas fa-times"></i>
									</button>
								{{/if}}
							</div>

						</div>
					</article>
					{{/each}}
				</div>
			</div>
		</div>

		<!-- INITIATIVE TAB -->
		<div class="tab initiative-tab" data-tab="initiative">
			<div class="tab-wrapper">
				<div class="mg-initiative-note">
					{{#if canEdit}}
					<div class="mg-content">
						<h2>Initiative Order</h2>
						<p>Reorder party members by dragging a card by it's grip area, or hide a member by clicking the hide from order button. This order is used for turn flow.</p>
						<div class="mg-initiative-actions" style="margin: 8px 0;">
							<button type="button" class="mg-apply-initiative">
							<i class="fa-solid fa-link"></i> Apply Initiative Order
							</button>
						</div>
					</div>
					{{else}}
					<h2>View-only initiative. Owners can reorder.</h2>
					{{/if}}
				</div>

				<div class="mg-initiative-list">
					{{#each initiativeMembers as |m|}}
					<article class="mg-init-card {{#if m.hidden}}is-muted{{/if}}" data-uuid="{{m.uuid}}" data-hidden="{{m.hidden}}">
						<div class="mg-init-portrait">
							<img src="{{m.img}}" alt="{{m.name}}" />
						</div>

						<div class="mg-init-main">
							<div class="mg-init-name">{{m.name}}</div>
							<div class="mg-init-meta">
							<span class="mg-init-class">{{m.className}}</span>
							<span class="mg-dot">&middot;</span>
							<span class="mg-init-level">Lv {{m.levelText}}</span>
							{{#if m.missing}}<span class="mg-init-missing">(Missing)</span>{{/if}}
							</div>
						</div>

						<!-- New: eye toggle (works even when you can’t drag) -->
						<div class="mg-init-actions">
							<button type="button"
									class="mg-init-eye"
									title="{{#if m.hidden}}Include in Initiative{{else}}Hide from Initiative{{/if}}"
									aria-pressed="{{#unless m.hidden}}true{{/unless}}">
							{{#if m.hidden}}
								<i class="fa-regular fa-eye-slash"></i>
							{{else}}
								<i class="fa-regular fa-eye"></i>
							{{/if}}
							</button>

							<div class="mg-init-grip" aria-hidden="true">
								<i class="fa-solid fa-grip-lines"></i>
							</div>
						</div>
					</article>
					{{/each}}
				</div>
			</div>
		</div>

		<!-- ASSETS TAB -->
		<div class="tab assets" data-tab="assets">

			<!-- Crew Lux controls -->
			<div class="assets-toolbar">

				<div class="crew-lux">
					<label for="lux">Lux</label>
					<div class="field-wrapper lux-controls">
						<button type="button" class="lux-dec" data-step="-1" title="−1">−</button>
						<input
						type="number"
						class="lux-value"
						name="system.currency.lux"
						value="{{system.currency.lux}}"
						min="0"
						inputmode="numeric"
						pattern="[0-9]*"
						aria-label="Lux"
						/>
						<button type="button" class="lux-inc" data-step="1" title="+1">+</button>
					</div>
				</div>

				<div class="asset-search-wrap">
					<label>Search Crew Assets</label>
					<div class="field-wrapper">
						<input type="text" class="asset-search" placeholder="Search query here..." />
						<button type="button" class="asset-search-btn" title="Search">
							<i class="fa-solid fa-magnifying-glass"></i>
						</button>
					</div>
				</div>
			</div>

			<div class="tab-wrapper">

				<!-- Drop zone wraps the grid -->
				<div class="mg-asset-drop">
					<div class="asset-grid">
						{{#each assets as |it|}}
						
						<article class="asset-card inventory-item" data-item-id="{{it.id}}">
							<h3 class="name post-asset" data-item-id="{{it.id}}">
									<i class="fa-solid fa-messages"></i> {{it.name}}
							</h3>

							<div class="card-media">
								<img src="{{it.img}}" alt="{{it.name}}">
							</div>

							<div class="card-wrapper">

								<div class="card-body">

								{{!-- Tags with overflow + "See all" toggle --}}
									{{#if it._tags.length}}
										<div class="tags-wrap" data-item-id="{{it.id}}">
											<div class="tags asset-tags">
											{{#each it._tags as |t|}}
												<span class="asset-tag tag" data-tag-id="{{t.id}}" title="Click for details">
													{{t.label}}
												</span>
											{{/each}}
											</div>
											<span class="tags-toggle" hidden>
												<i class="fa-solid fa-angle-down"></i>
											</span>
										</div>
									{{/if}}

									{{#if it.descHtml}}
									<div class="mg-seeall-wrap" data-item-id="{{it.id}}" data-seeall-cap="150">
										<div class="desc">
											<label>Description</label>

											<div class="desc-content mg-seeall-content">
												{{{it.descHtml}}}
											</div>
										</div>

										<button class="mg-seeall-toggle" type="button">
											<i class="fa-solid fa-angle-down"></i>
										</button>
									</div>
									{{/if}}

									{{#if it.notesHtml}}
									<div class="notes-wrap mg-seeall-wrap" data-item-id="{{it.id}}" data-seeall-cap="150">
									<div class="asset-notes">
										<label>Notes</label>
										<div class="notes-content mg-seeall-content">
										{{{it.notesHtml}}}
										</div>
									</div>
									<button class="mg-seeall-toggle" type="button">
										<i class="fa-solid fa-angle-down"></i>
									</button>
									</div>
									{{/if}}
									
								</div>

								<div class="card-actions">
									{{#if (gt it.system.qty 0)}}
										<div class="qty-badge" title="Quantity">
											<label>QTY</label>
											<p>{{it.system.qty}}</p>
										</div>
									{{/if}}

									<button type="button" class="asset-edit" data-item-id="{{it.id}}" title="Edit">
										<i class="fa-regular fa-pen-to-square"></i> Edit
									</button>
								</div>

							</div>
						</article>
						{{/each}}

						{{#unless assets.length}}
						<div class="empty-hint">
							<h3><i class="fa-solid fa-triangle-exclamation"></i> You have no Assets yet!</h3>
							<p>To get started, drag Assets here from the sidebar.</p>
						</div>
						{{/unless}}
					</div>

					<!-- Empty state for search -->
					<div class="asset-search-empty" style="display:none;">
					<h3><i class="fa-solid fa-triangle-exclamation"></i> Search did not return any matches, try again!</h3>
						<button type="button" class="asset-search-reset">
							<i class="fa-solid fa-rotate-left"></i> Reset
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- GAMBITS TAB -->
		<div class="tab gambits tab-gambits" data-tab="gambits">
			<div class="gambit-tab">
				<div class="gambit-header mg-content">
					<h2>Crew Gambits</h2>
					<p>Drag Gambits here from the compendium or your items. The crew can hold up to 3 active Gambits.</p>
					<button class="gambit-reset" type="button" title="Return all discarded Gambits to hand">
						<i class="fa-solid fa-rotate-left"></i> Reset Hand
					</button>
				</div>

				<div class="gambit-hand">
					<h2 class="gambit-banner">Hand</h2>

					<span class="deck-size gambit-counter" title="Cards in hand / hand capacity">
						Deck Size: {{gambitCounts.deckCount}}/{{gambitCounts.deckMax}}
					</span>

					{{#each gb.deck}}
					<div class="gambit-card" data-item-id="{{this.id}}">
						<div class="gambit-title">
						<button type="button" class="post-gambit" data-item-id="{{_id}}" title="Post to Chat">
							<i class="fa-solid fa-messages"></i>
							{{this.name}}
						</button>
						</div>
						<div class="gambit-wrapper">
							<div class="gambit-desc">
								{{{this.system.description}}}
							</div>

							<div class="status-buttons">
								<button class="play-gambit" title="Play Gambit"><i class="fa-solid fa-play"></i></button>
								<button class="discard-gambit" title="Move to Discard"><i class="fa-solid fa-recycle"></i></button>
								<button class="remove-gambit" title="Remove from Crew"><i class="fa-solid fa-delete-left"></i></button>
							</div>
						</div>
					</div>
					{{/each}}

					{{!-- Empty states --}}
					{{#unless gb.deck.length}}
						{{#if gb.hasAny}}
						<h3 class="empty mg-content">Hand is empty. Use <strong>Reset Hand</strong> to recover from Discard.</h3>
						{{else}}
						<h3 class="empty mg-content">No Crew Gambits yet. Drag some in from the Compendium.</h3>
						{{/if}}
					{{/unless}}
				</div>

				<div class="gambit-discard">
					<h2 class="gambit-banner">Discard</h2>
					{{#each gb.discard}}
						<div class="gambit-card faded" data-source="discard" draggable="false" data-item-id="{{id}}">
						<div class="gambit-title">{{name}}</div>
						<div class="gambit-description">
							{{{system.description}}}
						</div>
						</div>
					{{/each}}
				</div>
			</div>
		</div>

		<!-- BIO TAB -->
		<div class="tab bio-tab" data-tab="bio">
			<div class="mg-crew-bio">
				<div class="bio-grid mg-content">
					<div class="field">
						<label>Look &amp; Feel</label>
						{{editor
							system.bio.lookAndFeel
							target="system.bio.lookAndFeel"
							engine="tinymce"
							owner=owner
							editable=editable
							button=false
						}}
					</div>

					<div class="field">
						<label>Weakness</label>
						{{editor
							system.bio.weakness
							target="system.bio.weakness"
							engine="tinymce"
							owner=owner
							editable=editable
							button=false
						}}
					</div>

					<div class="field">
					<label>Location</label>
					{{editor
						system.bio.location
						target="system.bio.location"
						engine="tinymce"
						owner=owner
						editable=editable
						button=false
					}}
					</div>

					<div class="field">
						<label>Features</label>
						{{editor
							system.bio.features
							target="system.bio.features"
							engine="tinymce"
							owner=owner
							editable=editable
							button=false
						}}
					</div>

					<div class="field bio-tags">
						<label>Tags</label>

						<div class="tags-row">
							<input
							class="bio-add-tag"
							type="text"
							placeholder="Type a tag and press Enter (or comma)"
							aria-label="Add a tag"
							/>

							<div class="tag-list tag-wrapper" role="list">
							{{#each system.bio.tags as |t idx|}}
								<div class="tag-pill tag" role="listitem" data-idx="{{idx}}" title="{{t.desc}}">
									<span class="label">{{t.label}}</span>
									<button type="button" class="remove" title="Remove tag {{t.label}}" aria-label="Remove tag {{t.label}}">
										<i class="fa-solid fa-delete-left"></i>
									</button>
								</div>
							{{/each}}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- SETTINGS TAB -->
		<div class="tab settings-tab" data-tab="settings">
			<div class="mg-crew-settings">

				<!-- SETTINGS: Crew Tier -->
				<div class="field crew-tier-settings mg-content">

					<div class="crew-row">
						<div class="tier-container">
							<label>Crew Tier</label>
							<span>Tier {{crewTier}}</span>
						</div>

						{{#if levelPending}}
						<button type="button" class="mg-pending-glow mg-crew-review-level" title="Review crew level requirements">
							<i class="fa-solid fa-bolt"></i>
							Review Level Requirements
						</button>
						{{/if}}
					</div>

					<div class="btns">
						<button type="button" class="mg-crew-levelup">
							<i class="fa-solid fa-arrow-up"></i> Level Up
						</button>
						
						<button type="button" class="mg-crew-undo">
							<i class="fa-solid fa-rotate-left"></i> Undo Last Level
						</button>

						<button type="button" class="mg-crew-undo-all">
							<i class="fa-solid fa-arrow-rotate-left"></i> Undo to Tier 1
						</button>

					</div>
				</div>

				<div class="mg-diricon-row">
					<div class="mg-content">
						<h2>Directory Icon</h2>
						<p>This image only changes how the Crew appears in the <em>actors</em> sidebar.
						It does not change the Crew’s portrait or any tokens.</p>
					</div>

					<div class="diricon-settings">
						<div class="mg-diricon-preview" title="Directory Icon Preview">
							<img src="{{directoryIconResolved}}" alt="Directory Icon Preview" />
						</div>

						{{#if canEdit}}
						<div class="mg-diricon-actions">
							<button type="button" class="mg-pick-diricon">
							<i class="fa-regular fa-image"></i> Choose Icon
							</button>
							<button type="button" class="mg-clear-diricon">
							<i class="fa-solid fa-ban"></i> Clear
							</button>
						</div>
						{{/if}}
					</div>
				</div>
			</div>
		</div>

	</section>
</form>
