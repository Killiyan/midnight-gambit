<form class="mg-crew-sheet sheet actor flexcol" autocomplete="off">

	<nav class="sheet-tabs floating tabs">
		<a class="item" data-tab="party"><i class="fa-solid fa-users"></i> <span>Party</span></a>
		<a class="item" data-tab="initiative"><i class="fa-solid fa-list-ol"></i> <span>Initiative</span></a>
		<a class="item" data-tab="assets"><i class="fa-solid fa-vault"></i> <span>Assets</span></a>
		<a class="item" data-tab="gambits"><i class="fa-solid fa-cards-blank"></i><span>Gambits</span></a>
		<a class="item" data-tab="bio"><i class="fa-solid fa-id-card-clip"></i><span>Bio</span></a>
		<a class="item" data-tab="settings"><i class="fa-solid fa-gear"></i> <span>Settings</span></a>
	</nav>

	<!-- Splash banner: party portraits -->
	<div class="mg-crew-header">
		<!-- Crew Title / Name -->
		<div class="mg-crew-title">
			{{#if canEdit}}
			<input type="text"
					name="name"
					value="{{actor.name}}"
					class="mg-crew-name"
					placeholder="Crew Name" />
			{{else}}
			<h1 class="mg-crew-name-display">{{actor.name}}</h1>
			{{/if}}
			
			{{#if canEdit}}
			<div class="mg-initiative-actions" style="margin: 8px 0;">
				<button type="button" class="mg-apply-initiative">
				<i class="fa-solid fa-link"></i> Apply Initiative Order
				</button>
			</div>
			{{/if}}		

		</div>

		<div class="mg-splash-strip">
		{{#each splashImages as |img|}}
			<img class="mg-splash-portrait" src="{{img}}" alt="" />
		{{/each}}
		</div>
	</div>

	<section class="sheet-body">
		<!-- PARTY TAB -->
		<div class="tab party-tab" data-tab="party">
			<div class="tab-wrapper">
				<div class="mg-content">
					{{#if canEdit}}
					<h2>Party List</h2>
					<p>Drag characters from the Actors directory onto this sheet to add them to the party</p>
					{{else}}
					<h2>View Only</h2>
					<p>You can view the party. Owners can edit</p>
					{{/if}}
				</div>

				<div class="mg-party-grid">
					{{#each partyMembers as |m|}}
					<article class="mg-member-card" data-uuid="{{m.uuid}}">
						<div class="mg-member-portrait">
							<img src="{{m.img}}" alt="{{m.name}}" />
						</div>
						<div class="mg-member-info">
							<div class="mg-member-name">{{m.name}}</div>
							<div class="mg-member-meta">
								<span class="mg-member-class">{{m.className}}</span>
								<span class="mg-member-level">Lv {{m.levelText}}</span>
								{{#if m.missing}}<span class="mg-member-missing">(Missing)</span>{{/if}}
							</div>
						</div>

						<div class="mg-member-actions">

							<button type="button" class="mg-open-member" title="Open Character Sheet" aria-label="Open Character Sheet">
								<i class="fa-solid fa-address-card"></i>
							</button>

							{{#if ../canEdit}}
							<button type="button" class="mg-remove-member" title="Remove from Party">
								<i class="fas fa-times"></i>
							</button>
							{{/if}}
						</div>
					</article>
					{{/each}}
				</div>
			</div>
		</div>

		<!-- INITIATIVE TAB -->
		<div class="tab initiative-tab" data-tab="initiative">
			<div class="tab-wrapper">
				<div class="mg-initiative-note">
					{{#if canEdit}}
					<div class="mg-content">
						<h2>Initiative Order</h2>
						<p>Reorder party members by dragging a card by it's grip area, or hide a member by clicking the hide from order button. This order is used for turn flow.</p>
					</div>
					{{else}}
					<h2>View-only initiative. Owners can reorder.</h2>
					{{/if}}
				</div>

				<div class="mg-initiative-list">
					{{#each initiativeMembers as |m|}}
					<article class="mg-init-card {{#if m.hidden}}is-muted{{/if}}" data-uuid="{{m.uuid}}" data-hidden="{{m.hidden}}">
						<div class="mg-init-portrait">
							<img src="{{m.img}}" alt="{{m.name}}" />
						</div>

						<div class="mg-init-main">
							<div class="mg-init-name">{{m.name}}</div>
							<div class="mg-init-meta">
							<span class="mg-init-class">{{m.className}}</span>
							<span class="mg-dot">&middot;</span>
							<span class="mg-init-level">Lv {{m.levelText}}</span>
							{{#if m.missing}}<span class="mg-init-missing">(Missing)</span>{{/if}}
							</div>
						</div>

						<!-- New: eye toggle (works even when you can’t drag) -->
						<div class="mg-init-actions">
							<button type="button"
									class="mg-init-eye"
									title="{{#if m.hidden}}Include in Initiative{{else}}Hide from Initiative{{/if}}"
									aria-pressed="{{#unless m.hidden}}true{{/unless}}">
							{{#if m.hidden}}
								<i class="fa-regular fa-eye-slash"></i>
							{{else}}
								<i class="fa-regular fa-eye"></i>
							{{/if}}
							</button>

							<div class="mg-init-grip" aria-hidden="true">
								<i class="fa-solid fa-grip-lines"></i>
							</div>
						</div>
					</article>
					{{/each}}
				</div>
			</div>
		</div>

		<!-- ASSETS TAB -->
		<div class="tab assets" data-tab="assets">

			<!-- Crew Lux controls -->
			<div class="assets-toolbar">

				<div class="crew-lux">
					<label for="lux"><i class="fa-solid fa-coins"></i> Lux</label>
					<div class="field-wrapper lux-controls">
						<button type="button" class="lux-dec" data-step="-1" title="−1">−</button>
						<input
						type="number"
						class="lux-value"
						name="system.currency.lux"
						value="{{system.currency.lux}}"
						min="0"
						inputmode="numeric"
						pattern="[0-9]*"
						aria-label="Lux"
						/>
						<button type="button" class="lux-inc" data-step="1" title="+1">+</button>
					</div>
				</div>

				<div class="asset-search-wrap">
					<label><i class="fa-solid fa-magnifying-glass"></i> Search Crew Assets</label>
					<div class="field-wrapper">
						<input type="text" class="asset-search" placeholder="Search query here..." />
						<button type="button" class="asset-search-btn" title="Search">
							<i class="fa-solid fa-magnifying-glass"></i>
						</button>
					</div>
				</div>
			</div>

			<div class="tab-wrapper">

				<!-- Drop zone wraps the grid -->
				<div class="mg-asset-drop">
					<div class="asset-grid">
						{{#each assets as |it|}}
						
						<article class="asset-card inventory-item" data-item-id="{{it.id}}">
							<h3 class="name post-asset" data-item-id="{{it.id}}">
									<i class="fa-solid fa-messages"></i> {{it.name}}
							</h3>

							<div class="card-media">
								<img src="{{it.img}}" alt="{{it.name}}">
							</div>

							<div class="card-wrapper">

								<div class="card-body">

								{{!-- Tags with overflow + "See all" toggle --}}
									{{#if it._tags.length}}
										<div class="tags-wrap" data-item-id="{{it.id}}">
											<div class="tags asset-tags">
											{{#each it._tags as |t|}}
												<span class="asset-tag tag" data-tag-id="{{t.id}}" title="Click for details">
													{{t.label}}
												</span>
											{{/each}}
											</div>
											<span class="tags-toggle" hidden>
												<i class="fa-solid fa-angle-down"></i>
											</span>
										</div>
									{{/if}}

									{{#if it.descHtml}}
									<div class="mg-seeall-wrap" data-item-id="{{it.id}}">
										<div class="desc">
											<label>Description</label>

											<div class="desc-content mg-seeall-content">
												{{{it.descHtml}}}
											</div>
										</div>

										<button class="mg-seeall-toggle" type="button">
											<i class="fa-solid fa-angle-down"></i>
										</button>
									</div>
									{{/if}}

									{{#if it.notesHtml}}
									<div class="notes-wrap mg-seeall-wrap" data-item-id="{{it.id}}">
										<div class="asset-notes">
											<label>Notes</label>

											<div class="notes-content mg-seeall-content">
												{{{it.notesHtml}}}
											</div>
										</div>

										<button class="mg-seeall-toggle" type="button">
											<i class="fa-solid fa-angle-down"></i>
										</button>
									</div>
									{{/if}}
									
								</div>

								<div class="card-actions">
									<div class="qty-badge" title="Quantity"><label>QTY</label><p>{{it.system.qty}}</p></div>
									<button type="button" class="asset-edit" data-item-id="{{it.id}}" title="Edit">
										<i class="fa-regular fa-pen-to-square"></i> Edit
									</button>
								</div>

							</div>
						</article>
						{{/each}}

						{{#unless assets.length}}
						<div class="empty-hint">
							<h3><i class="fa-solid fa-triangle-exclamation"></i> You have no Assets yet!</h3>
							<p>To get started, drag Assets here from the sidebar.</p>
						</div>
						{{/unless}}
					</div>

					<!-- Empty state for search -->
					<div class="asset-search-empty" style="display:none;">
					<h3><i class="fa-solid fa-triangle-exclamation"></i> Search did not return any matches, try again!</h3>
						<button type="button" class="asset-search-reset">
							<i class="fa-solid fa-rotate-left"></i> Reset
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- GAMBITS TAB -->
		<div class="tab crew-gambits" data-tab="gambits">
			<div class="mg-crew-gambits">
				<div class="mg-crew-gb-controls">
				<div class="left">
					<button class="gb-draw" {{#unless isEditable}}disabled{{/unless}}><i class="fa-light fa-hand-holding"></i> Draw</button>
					<span class="hint">Hand {{gb.drawn.length}}/{{gb.handSize}}</span>
				</div>
				<div class="right">
					<button class="gb-shuffle" {{#unless isEditable}}disabled{{/unless}}><i class="fa-light fa-shuffle"></i> Shuffle</button>
					<button class="gb-recall"  {{#unless isEditable}}disabled{{/unless}}><i class="fa-light fa-rotate-left"></i> Recall Discard</button>
				</div>
				</div>

				<div class="mg-crew-gb-drop hint">Drag Gambit items here to add to the Deck.</div>

				<div class="mg-crew-gb-zones">
				<div class="zone deck">
					<h4>Deck ({{gb.deck.length}})</h4>
					<ul class="deck-list">
					{{#if gb.deck.length}}
						{{#each gb.deck}}
						<li class="card" data-id="{{this.id}}">{{this.name}}</li>
						{{/each}}
					{{else}} <li class="empty"><em>Empty</em></li> {{/if}}
					</ul>
				</div>

				<div class="zone hand">
					<h4>Hand ({{gb.drawn.length}}/{{gb.handSize}})</h4>
					<ul class="hand-list">
					{{#if gb.drawn.length}}
						{{#each gb.drawn}}
						<li class="card drawn" data-id="{{this.id}}">
							<span class="title">{{this.name}}</span>
							<div class="actions">
							<button class="gb-play" data-id="{{this.id}}" {{#unless @root.isEditable}}disabled{{/unless}}>
								<i class="fa-light fa-sparkles"></i> Play
							</button>
							<button class="gb-discard" data-id="{{this.id}}" {{#unless @root.isEditable}}disabled{{/unless}}>
								<i class="fa-light fa-box-archive"></i>
							</button>
							</div>
						</li>
						{{/each}}
					{{else}} <li class="empty"><em>No cards in hand</em></li> {{/if}}
					</ul>
				</div>

				<div class="zone discard">
					<h4>Discard ({{gb.discard.length}})</h4>
					<ul class="discard-list">
					{{#if gb.discard.length}}
						{{#each gb.discard}}
						<li class="card" data-id="{{this.id}}">{{this.name}}</li>
						{{/each}}
					{{else}} <li class="empty"><em>Empty</em></li> {{/if}}
					</ul>
				</div>
				</div>
			</div>
		</div>

		<!-- BIO TAB -->
		<div class="tab bio-tab" data-tab="bio">
			<div class="mg-crew-bio">
				<div class="bio-grid">
				<div class="field">
					<label>Look &amp; Feel</label>
					<textarea class="bio-look">{{system.bio.lookAndFeel}}</textarea>
				</div>
				<div class="field">
					<label>Weakness</label>
					<textarea class="bio-weak">{{system.bio.weakness}}</textarea>
				</div>
				<div class="field">
					<label>Location</label>
					<input class="bio-location" type="text" value="{{system.bio.location}}">
				</div>
				<div class="field">
					<label>Features</label>
					<textarea class="bio-features">{{system.bio.features}}</textarea>
				</div>

				<div class="field">
					<label>Tags (placeholder)</label>
					<div class="tags-row">
					<input class="bio-add-tag" type="text" placeholder="Type a tag and press Enter">
					<div class="tag-list">
						{{#each system.bio.tags as |t idx|}}
						<span class="tag" data-idx="{{idx}}">{{t}} <i class="fa-light fa-xmark"></i></span>
						{{/each}}
					</div>
					</div>
					<small>We’ll wire effectful tags later.</small>
				</div>
				</div>
			</div>
		</div>

		<!-- SETTINGS TAB -->
		<div class="tab settings-tab" data-tab="settings">
		<div class="mg-crew-settings">

			<div class="mg-diricon-row">
				<div class="mg-content">
					<h2>Directory Icon</h2>
					<p>This image only changes how the Crew appears in the <em>actors</em> sidebar.
					It does not change the Crew’s portrait or any tokens.</p>
				</div>

				<div class="diricon-settings">
					<div class="mg-diricon-preview" title="Directory Icon Preview">
						{{#if directoryIconResolved}}
							<img src="{{directoryIconResolved}}"
							alt="Directory Icon Preview" />
						{{else}}
							<img src="systems/midnight-gambit/assets/images/mg-queen.png"
							alt="Directory Icon Preview" />
						{{/if}}
					</div>

					{{#if canEdit}}
					<div class="mg-diricon-actions">
						<button type="button" class="mg-pick-diricon">
						<i class="fa-regular fa-image"></i> Choose Icon
						</button>
						<button type="button" class="mg-clear-diricon">
						<i class="fa-solid fa-ban"></i> Clear
						</button>
					</div>
					{{/if}}
				</div>
			</div>
		</div>
		</div>

	</section>
</form>
